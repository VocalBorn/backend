# VocalBorn 權限系統使用說明

## 概述

VocalBorn 系統實作了基於角色的權限控制（RBAC），將使用者分為三種角色，每種角色都有不同的權限和功能。

## 使用者角色

### 1. 一般使用者 (CLIENT)
**主要功能：** 檢視課程且與語言治療師溝通

**權限包括：**
- `view_courses` - 檢視課程內容
- `view_practice_records` - 檢視練習記錄
- `create_practice_records` - 創建練習記錄
- `chat_with_therapist` - 與語言治療師溝通

**可存取的 API：**
- GET `/situations/list` - 檢視情境列表
- GET `/situations/{situation_id}` - 檢視情境詳情
- GET `/situations/{situation_id}/chapter/list` - 檢視章節列表
- GET `/situations/chapter/{chapter_id}` - 檢視章節詳情
- GET `/situations/chapters/{chapter_id}/sentences` - 檢視語句列表
- GET `/situations/sentence/{sentence_id}` - 檢視語句詳情
- GET `/admin/my-permissions` - 查看自己的權限

### 2. 語言治療師 (THERAPIST)
**主要功能：** 檢視課程且與使用者溝通

**權限包括：**
- `view_courses` - 檢視課程內容
- `view_practice_records` - 檢視練習記錄
- `chat_with_client` - 與一般使用者溝通

**可存取的 API：**
- 所有一般使用者可存取的課程檢視 API
- GET `/admin/my-permissions` - 查看自己的權限

### 3. 管理員 (ADMIN)
**主要功能：** 對課程進行編輯

**權限包括：**
- `view_courses` - 檢視課程內容
- `edit_courses` - 編輯課程內容
- `delete_courses` - 刪除課程
- `create_courses` - 創建課程
- `view_practice_records` - 檢視練習記錄
- `chat_with_therapist` - 與語言治療師溝通
- `chat_with_client` - 與一般使用者溝通
- `manage_users` - 管理使用者
- `view_all_users` - 檢視所有使用者

**可存取的 API：**
- 所有課程相關的 CRUD 操作
- POST `/situations/create` - 創建情境
- PATCH `/situations/{situation_id}` - 更新情境
- DELETE `/situations/{situation_id}` - 刪除情境
- POST `/situations/{situation_id}/chapter/create` - 創建章節
- PATCH `/situations/chapter/{chapter_id}` - 更新章節
- DELETE `/situations/chapter/{chapter_id}` - 刪除章節
- PATCH `/situations/{situation_id}/chapter/reorder` - 重新排序章節
- POST `/situations/chapters/{chapter_id}/sentences` - 創建語句
- PATCH `/situations/sentence/{sentence_id}` - 更新語句
- DELETE `/situations/sentence/{sentence_id}` - 刪除語句
- 所有管理員 API（`/admin/*`）

## 管理員功能 API

### 使用者管理
- GET `/admin/users` - 獲取所有使用者列表
- GET `/admin/users/stats` - 獲取使用者統計資訊
- GET `/admin/users/therapists` - 獲取所有語言治療師
- GET `/admin/users/clients` - 獲取所有一般使用者
- PUT `/admin/users/{user_id}/role` - 更新使用者角色
- POST `/admin/users/{user_id}/promote-to-therapist` - 提升為語言治療師
- POST `/admin/users/{user_id}/promote-to-admin` - 提升為管理員
- POST `/admin/users/{user_id}/demote-to-client` - 降級為一般使用者

### 權限查詢
- GET `/admin/permissions/{role}` - 獲取指定角色的權限列表
- GET `/admin/my-permissions` - 獲取當前使用者的權限列表

## 使用方式

### 1. 權限檢查裝飾器

```python
from src.auth.services.permission_service import require_permission, Permission

# 需要特定權限
@require_permission(Permission.EDIT_COURSES)
async def some_function(current_user: User = Depends(get_current_user)):
    # 只有有編輯課程權限的使用者可以存取
    pass
```

### 2. 角色檢查裝飾器

```python
from src.auth.services.permission_service import require_role, UserRole

# 需要特定角色
@require_role([UserRole.ADMIN, UserRole.THERAPIST])
async def some_function(current_user: User = Depends(get_current_user)):
    # 只有管理員或語言治療師可以存取
    pass
```

### 3. 預定義的權限依賴項

```python
from src.auth.services.permission_service import RequireEditCourses, RequireAdmin

# 使用預定義的權限檢查
async def edit_course(current_user: User = Depends(RequireEditCourses)):
    # 只有有編輯課程權限的使用者可以存取
    pass

# 使用預定義的角色檢查
async def admin_function(current_user: User = Depends(RequireAdmin)):
    # 只有管理員可以存取
    pass
```

## 權限系統架構

### 核心組件

1. **Permission 類** - 定義所有系統權限
2. **RolePermissions 類** - 定義角色與權限的映射關係
3. **權限檢查函數** - 提供權限驗證功能
4. **依賴項** - FastAPI 依賴注入式權限檢查

### 錯誤處理

- **401 Unauthorized** - 未登入或 token 無效
- **403 Forbidden** - 權限不足
- **404 Not Found** - 使用者不存在

## 安全考量

1. **最小權限原則** - 每個角色只有執行其職責所需的最小權限
2. **權限隔離** - 不同角色之間的權限明確分離
3. **防護措施** - 管理員無法修改自己的角色，防止意外降權
4. **JWT 驗證** - 所有 API 都需要有效的 JWT token

## 擴展性

系統設計支援輕鬆添加新的權限和角色：

1. 在 `Permission` 類中添加新權限
2. 在 `RolePermissions` 類中更新角色權限映射
3. 創建新的依賴項（如需要）
4. 在路由中應用新的權限檢查

這個權限系統確保了 VocalBorn 平台的安全性，同時提供了靈活的角色管理功能。
